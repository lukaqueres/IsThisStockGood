<notifications-container></notifications-container>

<script>

    class Notification extends HTMLElement {
        constructor() {
            super();

            this.attachShadow({ mode: "open" });

            const wrapper = document.createElement("div");
            wrapper.setAttribute("id", "wrapper");

            const header = wrapper.appendChild(document.createElement("div"));
            header.setAttribute("id", "header");

            if ( this.dataset.size === "small" ) {
                this.icon = header.appendChild(document.createElement("div"));
                this.icon.setAttribute("id", "icon-small");

                this.heading = header.appendChild(document.createElement("p"));
            } else {
                this.icon = wrapper.appendChild(document.createElement("div"));
                this.icon.setAttribute("id", "icon-large");

                this.heading = wrapper.appendChild(document.createElement("p"));
            }

            this.dataset.counter = 1;

            this.counter = header.appendChild(document.createElement("span"));
            this.counter.setAttribute("id", "counter");
            this.counter.appendChild(document.createTextNode(this.dataset.counter == 1 ? "" : "this.dataset.counter"));
            if ( this.dataset.counter == 1 ) {
                this.counter.setAttribute("class", "void");
            }

            const clear = header.appendChild(document.createElement("button"));
            clear.setAttribute("id", "clear-button");
            clear.appendChild(document.createElement("ion-icon")).setAttribute("name", "close-circle-outline");
            clear.addEventListener("click", (event) => { this.remove(); });

            this.heading.setAttribute("id", "heading");
            this.heading.appendChild(document.createTextNode("heading" in this.dataset ? this.dataset.heading : ""));

            this.content = wrapper.appendChild(document.createElement("div"));
            this.content.setAttribute("id", "content");
            this.content.appendChild(document.createTextNode("content" in this.dataset ? this.dataset.content : ""));

            this.footer = wrapper.appendChild(document.createElement("div"));
            this.footer.setAttribute("id", "footer");
            this.footer.appendChild(document.createTextNode("footer" in this.dataset ? this.dataset.footer : ""));

            const style = document.createElement("style");
            style.textContent = `
                :root {
                    --color-accent: inherit;

                    --font-color: inherit;
                    --font-color-secondary: inherit;
                }

                #wrapper {
                    width: 100%;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                }

                #counter {
                    width: 1rem;
                    height: 1rem;
                    border-radius: 10rem;
                    /*border: 1px solid white;*/
                    background-color: transparent;
                    box-sizing: border-box;
                    /*color: white;*/
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                    #counter::before {
                        content: "x";
                    }

                    #counter.void {
                        display: none;
                    }

                .void {
                    display: none;
                }

                #clear-button {
                    align-self: flex-start;
                    background-color: transparent;
                    border: none;
                    color: white;
                    text-transform: uppercase;
                    transform: translate(25%, 0);
                    transition: all 0.5s;
                    width: 1rem;
                    height: 1rem;
                }

                    #clear-button > ion-icon {
                        width: 1rem;
                        height: 1rem;
                    }

                    #clear-button:hover {
                        cursor: pointer;
                        color: #3e1f6d;
                    }

                #header {
                      display: flex;
                      justify-content: end;
                      width: 100%;
                      margin-bottom: 0.5rem;
                      align-items: center;
                }

                #heading {
                    text-align: center;
                    text-align: center;
                    color: white;
                    text-transform: uppercase;
                    font-size: large;
                    letter-spacing: 0.25rem;
                    margin: 0.5rem 1rem;
                }

                #icon-large, #icon-small {
                    color: white;
                }

                    #icon-large > ion-icon {
                        width: 3rem;
                        height: 4rem;
                    }

                    #icon-small > ion-icon {
                        width: 2rem;
                        height: 2rem;
                    }

                #content {
                    text-align: justify;
                    font-weight: lighter;
                }

                `;

            this.shadowRoot.append(style, wrapper);
            
            this.timeout = null;
            this.timeout_delay = null;
            this.fade(("time" in this.dataset && this.dataset.time) ? this.dataset.time : 10000);

            this.addEventListener("mouseover", (event) => {this.re_fade()});
            this.addEventListener("click", (event) => {this.re_fade()});

        }

        re_fade() {
            if ( !(this.timeout == null )) {
                this.fade(("time" in this.dataset && this.dataset.time) ? this.dataset.time : 10000);
            }
        }

        static get observedAttributes() { return ['data-heading', 'data-content', 'data-footer', 'data-time', 'data-icon', 'data-counter']; }

        attributeChangedCallback(name, oldValue, newValue) {
            if ( name == "data-heading" ) {
                this.heading.textContent = ( newValue ? newValue : "" );
            }
            if ( name == "data-content" ) {
                this.content.textContent = ( newValue ? newValue : "" );
            }
            if ( name == "data-footer" ) {
                this.footer.textContent = ( newValue ? newValue : "" );
            }
            if ( name == "data-time" ) {
                this.fade(("time" in this.dataset && this.dataset.time) ? this.dataset.time : 10000);
            }
            if ( name == "data-icon" ) {
                this.icon.innerHTML = '';
                const icon = this.icon.appendChild(document.createElement("ion-icon"));
                icon.setAttribute("name", this.dataset.icon);
            }
            if ( name == "data-counter" ) {
                this.counter.innerText = this.dataset.counter;
                if ( this.dataset.counter == 1 ) {
                    this.counter.classList.add("void");
                } else {
                    this.counter.classList.remove("void");
                }
                this.re_fade()
            }
        }

        fade(time) {
            window.clearTimeout(this.timeout);
            window.clearTimeout(this.timeout_delay);
            if ( time === true ) {
                this.timeout = clearTimeout(this.timeout);
                this.timeout_delay = clearTimeout(this.timeout_delay);
                return;
            }
            this.timeout_delay = setTimeout (() => {
                this.style["transition"] = `opacity 1s`;
                this.style["opacity"] = "1";
                this.timeout = setTimeout( () => {
                    if ( typeof time === "number" ) {
                        this.style["transition"] = `opacity ${ time / 1000 }s`;
                        this.style["opacity"] = "0";
                        this.timeout = setTimeout(() => {
                            this.remove();
                        }, time);
                    } else if ( time === true ) {

                    } else {
                        console.log(`Invalid fade time value: ${time}`);
                    }
                }, 2500);
            }, 10);
        }

    }

    customElements.define("popup-notification", Notification);

    class Notifications extends HTMLElement {
        constructor() {
            super();

            this.attachShadow({ mode: "open" });

            const wrapper = document.createElement("div");
            wrapper.setAttribute("class", "wrapper");
            this.wrapper = wrapper;

            const footer = wrapper.appendChild(document.createElement("div"));
            footer.setAttribute("class", "footer");
            this.footer = footer;

            const clear = footer.appendChild(document.createElement("button"));
            clear.setAttribute("class", "clear");
            clear.appendChild(document.createTextNode("Clear"));

            clear.addEventListener("click", (event) => { this.remove_all(); });

            const style = document.createElement("style");
            style.textContent = `
                :root {
                    --color-accent: inherit;
                    --color-accent-secondary: inherit;

                    --color-primary: inherit;
                    --color-primary-secondary: inherit;

                    --font-color: inherit;
                    --font-color-secondary: inherit;
                }

                .wrapper {
                    z-index: 99;
                    position: fixed;
                    top: 0;
                    padding-inline: 0.5rem;
                    ${"position" in this.dataset ? this.dataset.position : "right"}: 0;
                    width: 20rem;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    font-size: smaller;
                }

                .notification {
                    color: #30125e;
                    display: inline-block;
                    margin: 0.5rem;
                    padding: 0.5rem 1rem 1rem;
                    background-color: #6a91ff;
                    background: linear-gradient( 90deg, #6a91ff, #a380ff );
                    border-radius: 1rem;
                    width: 100%;
                    box-sizing: border-box;
                }

                    .notification.warning {
                        color: #6c2831;
                        background-color: #fdc19f;
                        background: linear-gradient( 90deg, #fdc19f, #f38b99 );
                    }

                .footer {
                    display: none;
                    width: 100%;
                    padding-inline: 1rem;
                    box-sizing: border-box;
                }

                .footer.show {
                    display: flex;
                    align-items: center;
                    justify-content: end;
                }

                .footer .clear {
                    color: var(--font-color-secondary);
                    border: none;
                    transition: all 0.5s;
                    background-color: transparent;
                }

                .footer .clear:hover {
                    cursor: pointer;
                    text-decoration: underline;
                }

                `;

            this.shadowRoot.append(style, wrapper);

            Element.prototype.add = this.add;

            var observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {

                if (mutation.removedNodes.length) {
                    //console.log("removed nodes", mutation.removedNodes[0].nodeValue);
                    if ( this.wrapper.childNodes.length > 1 ) {
                        this.footer.classList.add("show");
                    } else {
                        this.footer.classList.remove("show");
                    }
                }

                if (mutation.addedNodes.length) {
                    //console.log("added nodes", mutation.addedNodes[0].nodeValue);
                    if ( this.wrapper.childNodes.length > 1 ) {
                        this.footer.classList.add("show");
                    } else {
                        this.footer.classList.remove("show");
                    }
                }

                });
            });

            var config = {
                childList: true,
                subtree: true,
                characterData: true
            };

            observer.observe(this.wrapper, config);

        }

        from_html(html) {
            var template = document.createElement('template');
            html = html.trim();
            template.innerHTML = html;
            return template.content.firstChild;
        }

        add(heading, content, footer = null, icon = null, size = null, time = null, type = null) {
            let exists = false;
            for ( const element of this.wrapper.childNodes) {
                if ( element.dataset.heading == heading) {
                    exists = element;
                    break;
                }
            }
            if ( exists ) {
                exists.dataset.counter = parseInt(exists.dataset.counter ? exists.dataset.counter : 1) + 1;
                return ;
            }
            // const notification = document.createElement("popup-notification", {dataset: {size: size, time: time}});
            const notification = this.from_html(`<popup-notification data-size="${size}" data-time="${time ? time : ""}"></popup-notification>`)
            notification.setAttribute("class", "notification");
            if ( type ) {
                notification.classList.add(type);
            }
            notification.dataset.heading = heading;
            notification.dataset.content = content;
            if ( footer ) {
                notification.dataset.footer = footer;
            }
            if ( icon ) {
                notification.dataset.icon = icon;
            }
            if ( time ) {
                notification.dataset.time = time;
            }
            this.wrapper.insertBefore(notification, this.footer);
        }

        remove_all() {
            while (this.wrapper.firstChild) {
                if ( this.wrapper.firstChild != this.footer ) {
                    this.wrapper.removeChild(this.wrapper.firstChild);
                } else {
                    break;
                }
            }
        }

    }

    customElements.define("notifications-container", Notifications);
</script>